{% extends "base.html" %}

{% block title %}Добавить транзакцию{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Добавить новую транзакцию</h1>

    <form method="POST" action="{{ url_for('main.ui_add_transaction_form') }}" id="transaction-form" autocomplete="off">
        
        <!-- Тип транзакции -->
        <div class="form-group mb-3">
            <label for="transaction_type"><strong>Тип транзакции</strong></label>
            <select class="form-select" id="transaction_type" name="transaction_type">
                <option value="expense">Расход</option>
                <option value="income">Доход</option>
                <option value="transfer">Перевод</option>
                <option value="purchase">Покупка (QR-сканер)</option>
                <option value="manual_purchase">Покупка (ручной ввод)</option>
                <option value="exchange">Обмен валюты</option>
            </select>
        </div>

        <!-- Общие поля для всех типов -->
        <div class="row">
            <div class="col-md-6 form-group mb-3">
                <label for="date">Дата и время</label>
                <input type="datetime-local" class="form-control" id="date" name="date" value="{{ now.strftime('%Y-%m-%dT%H:%M') }}" required>
            </div>
            <div class="col-md-6 form-group mb-3">
                <label for="account_id" id="account_id_label">Счет списания</label>
                <select class="form-select" id="account_id" name="account_id" required>
                    {% for acc in accounts %}
                    <option value="{{ acc.id }}">{{ acc.name }} ({{ acc.balance|trim_zeros }} {{ acc.currency }})</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Поля для РАСХОДА / ДОХОДА -->
        <div id="income-expense-fields">
            <div class="form-group mb-3">
                <label for="amount" id="amount_label">Сумма</label>
                <input type="number" step="0.01" class="form-control" id="amount" name="amount" placeholder="123.45">
            </div>
        </div>

        <div id="to-amount-field" style="display: none;">
            <div class="form-group mb-3">
                <label for="to_amount">Сумма зачисления</label>
                <input type="number" step="0.01" class="form-control" id="to_amount" name="to_amount" placeholder="9000.00">
            </div>
        </div>

        <!-- Поля для КАТЕГОРИИ (Расход/Доход) -->
        <div id="category-field" class="form-group mb-3">
            <label for="category_id">Категория</label>
            <select class="form-select" id="category_id" name="category_id">
                <!-- Опции будут добавлены динамически -->
            </select>
        </div>

        <!-- Поля для ПЕРЕВОДА -->
        <div id="transfer-fields" style="display: none;">
            <div class="form-group mb-3">
                <label for="to_account_id">Счет зачисления</label>
                <select class="form-select" id="to_account_id" name="to_account_id">
                    {% for acc in accounts %}
                    <option value="{{ acc.id }}">{{ acc.name }} ({{ acc.balance|trim_zeros }} {{ acc.currency }})</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Общие поля для покупок -->
        <div id="purchase-common-fields" style="display: none;">
            <div class="form-group mb-3">
                <label for="merchant">Место покупки / Продавец</label>
                <input type="text" class="form-control" id="merchant" name="merchant" placeholder="Например, Пятерочка">
            </div>
        </div>

        <!-- Поля для ПОКУПКИ c QR -->
        <div id="purchase-qr-fields" style="display: none;">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Загрузка по QR-коду чека</h5>
                </div>
                <div class="card-body">
                    <div class="form-group mb-3">
                        <label for="qr_image_input">Фотография чека с QR-кодом</label>
                        <input type="file" class="form-control" id="qr_image_input" accept="image/*">
                    </div>
                    <div id="qr-status" class="mt-2"></div>
                </div>
            </div>
        </div>

        <!-- Контейнер для товаров в покупке -->
        <div id="purchase-items-fields" style="display: none;">
            <h5 class="mt-4">Товары в покупке</h5>
            <div id="items-container"></div>
            <button type="button" class="btn btn-success mt-2" id="add-item-btn">Добавить товар</button>
        </div>

        <!-- Общее поле для описания -->
        <div class="form-group mb-3 mt-3">
            <label for="description">Описание / Комментарий</label>
            <textarea class="form-control" id="description" name="description" rows="3"></textarea>
        </div>

        <button type="submit" class="btn btn-primary mt-3">Сохранить транзакцию</button>
        <a href="{{ url_for('main.ui_transactions') }}" class="btn btn-secondary mt-3">Отмена</a>
    </form>
</div>

<!-- Шаблон для строки товара (для типа "Покупка") -->
<template id="item-template">
    <div class="row mb-2 align-items-center item-row">
        <div class="col-md-4">
            <input type="text" name="item_name[]" class="form-control" placeholder="Название товара" required>
        </div>
        <div class="col-md-2">
            <input type="number" step="0.001" name="item_quantity[]" class="form-control" placeholder="Кол-во" value="1" required>
        </div>
        <div class="col-md-2">
            <input type="number" step="0.01" name="item_price[]" class="form-control" placeholder="Цена" required>
        </div>
        <div class="col-md-3">
            <select name="item_category_id[]" class="form-select">
                <option value="">-- Без категории --</option>
                {% for parent_cat in expense_categories %}
                    <optgroup label="{{ parent_cat.name }}">
                        <option value="{{ parent_cat.id }}">{{ parent_cat.name }} (основная)</option>
                        {% for sub_cat in parent_cat.subcategories %}
                            <option value="{{ sub_cat.id }}">{{ sub_cat.name }}</option>
                        {% endfor %}
                    </optgroup>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-1">
            <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.item-row').remove()">X</button>
        </div>
    </div>
</template>

<!-- Скрытые select'ы с категориями для JS -->
<div style="display: none;">
    <select id="income-categories-source">
        <option value="">-- Без категории --</option>
        {% for parent_cat in income_categories %}
            <optgroup label="{{ parent_cat.name }}">
                <option value="{{ parent_cat.id }}">{{ parent_cat.name }} (основная)</option>
                {% for sub_cat in parent_cat.subcategories %}
                    <option value="{{ sub_cat.id }}">{{ sub_cat.name }}</option>
                {% endfor %}
            </optgroup>
        {% endfor %}
    </select>
    <select id="expense-categories-source">
        <option value="">-- Без категории --</option>
        {% for parent_cat in expense_categories %}
            <optgroup label="{{ parent_cat.name }}">
                <option value="{{ parent_cat.id }}">{{ parent_cat.name }} (основная)</option>
                {% for sub_cat in parent_cat.subcategories %}
                    <option value="{{ sub_cat.id }}">{{ sub_cat.name }}</option>
                {% endfor %}
            </optgroup>
        {% endfor %}
    </select>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const typeSelect = document.getElementById('transaction_type');
    const addItemBtn = document.getElementById('add-item-btn');
    const qrImageInput = document.getElementById('qr_image_input');
    const statusDiv = document.getElementById('qr-status');

    // --- Функция для обновления видимости полей формы ---
    function updateFormFields() {
        const type = typeSelect.value;
        
        // Скрываем все специфичные блоки
        document.getElementById('income-expense-fields').style.display = 'none';
        document.getElementById('transfer-fields').style.display = 'none';
        document.getElementById('to-amount-field').style.display = 'none';
        document.getElementById('purchase-common-fields').style.display = 'none';
        document.getElementById('purchase-qr-fields').style.display = 'none';
        document.getElementById('purchase-items-fields').style.display = 'none';
        document.getElementById('category-field').style.display = 'none';

        // Сбрасываем required атрибуты
        document.getElementById('amount').required = false;
        document.getElementById('to_account_id').required = false;
        document.getElementById('to_amount').required = false;

        // Настраиваем видимость и обязательность полей
        if (type === 'income' || type === 'expense') {
            document.getElementById('income-expense-fields').style.display = 'block';
            document.getElementById('category-field').style.display = 'block';
            document.getElementById('amount').required = true;
            document.getElementById('account_id_label').textContent = (type === 'income') ? 'Счет зачисления' : 'Счет списания';
            document.getElementById('amount_label').textContent = 'Сумма';
            
            // Обновляем список категорий
            const categorySelect = document.getElementById('category_id');
            const sourceId = (type === 'income') ? 'income-categories-source' : 'expense-categories-source';
            categorySelect.innerHTML = document.getElementById(sourceId).innerHTML;

        } else if (type === 'transfer') {
            document.getElementById('income-expense-fields').style.display = 'block';
            document.getElementById('transfer-fields').style.display = 'block';
            document.getElementById('amount').required = true;
            document.getElementById('to_account_id').required = true;
            document.getElementById('account_id_label').textContent = 'Счет списания';
            document.getElementById('amount_label').textContent = 'Сумма';

        } else if (type === 'exchange') {
            document.getElementById('income-expense-fields').style.display = 'block';
            document.getElementById('to-amount-field').style.display = 'block';
            document.getElementById('transfer-fields').style.display = 'block';
            document.getElementById('amount').required = true;
            document.getElementById('to_amount').required = true;
            document.getElementById('to_account_id').required = true;
            document.getElementById('account_id_label').textContent = 'Счет списания';
            document.getElementById('amount_label').textContent = 'Сумма списания';
            
        } else if (type === 'purchase' || type === 'manual_purchase') {
            document.getElementById('amount_label').textContent = 'Сумма';
            document.getElementById('purchase-common-fields').style.display = 'block';
            document.getElementById('purchase-items-fields').style.display = 'block';
            document.getElementById('account_id_label').textContent = 'Счет списания';

            if (type === 'purchase') {
                document.getElementById('purchase-qr-fields').style.display = 'block';
            }
        }
    }

    // --- Функция для добавления строки товара ---
    function addItemRow(itemData = {}) {
        const template = document.getElementById('item-template');
        const container = document.getElementById('items-container');
        const clone = template.content.cloneNode(true);

        if (itemData.name) clone.querySelector('[name="item_name[]"]').value = itemData.name;
        if (itemData.quantity) clone.querySelector('[name="item_quantity[]"]').value = itemData.quantity;
        if (itemData.price) clone.querySelector('[name="item_price[]"]').value = itemData.price;
        if (itemData.category_id) clone.querySelector('[name="item_category_id[]"]').value = itemData.category_id;

        container.appendChild(clone);
    }

    // --- Функция для отправки данных QR на сервер ---
    async function parseQrDataWithApi(qrString) {
        statusDiv.className = 'text-info';
        statusDiv.textContent = 'QR-код найден. Отправка запроса в ФНС...';

        try {
            const response = await fetch("{{ url_for('api.handle_parse_qr') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ qr_string: qrString })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || `Ошибка сервера: ${response.status}`);
            }

            if (data.date) {
                document.getElementById('date').value = data.date.slice(0, 16);
            }

            if (data.merchant) {
                document.getElementById('merchant').value = data.merchant;
            }

            const itemsContainer = document.getElementById('items-container');
            itemsContainer.innerHTML = ''; // Очищаем старые товары

            if (data.items && data.items.length > 0) {
                data.items.forEach(item => addItemRow(item));
                statusDiv.className = 'alert alert-success';
                statusDiv.textContent = `Чек успешно разобран. Найдено товаров: ${data.items.length}.`;
            } else {
                statusDiv.className = 'alert alert-warning';
                statusDiv.textContent = 'В чеке не найдено товаров.';
            }

        } catch (error) {
            statusDiv.className = 'alert alert-danger';
            statusDiv.textContent = `Ошибка: ${error.message}`;
        }
    }

    // --- Функция для обработки и сканирования изображения ---
    function handleQrImageScan(file) {
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d', { willReadFrequently: true });
                canvas.width = img.width;
                canvas.height = img.height;
                context.drawImage(img, 0, 0, img.width, img.height);

                const imageData = context.getImageData(0, 0, img.width, img.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });

                if (code) {
                    parseQrDataWithApi(code.data);
                } else {
                    statusDiv.className = 'alert alert-danger';
                    statusDiv.textContent = 'QR-код не найден на изображении. Попробуйте другое фото.';
                }
            };
            img.onerror = function() {
                statusDiv.className = 'alert alert-danger';
                statusDiv.textContent = 'Не удалось загрузить изображение. Возможно, файл поврежден или не является изображением.';
            };
            img.src = e.target.result;
        }
        reader.readAsDataURL(file);
        statusDiv.className = 'text-info';
        statusDiv.textContent = 'Анализ изображения...';
    }

    // --- Привязка обработчиков событий ---
    typeSelect.addEventListener('change', updateFormFields);
    addItemBtn.addEventListener('click', () => addItemRow());
    qrImageInput.addEventListener('change', (e) => handleQrImageScan(e.target.files[0]));

    // --- Инициализация формы при загрузке ---
    updateFormFields();
    // Для типа "Покупка" добавляем одну пустую строку по умолчанию
    if (typeSelect.value === 'manual_purchase') {
        addItemRow();
    }
});
</script>
{% endblock %}