{% extends "base.html" %}

{% block title %}Банковские операции{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Банковские операции</h2>
        <a href="{{ url_for('main.ui_add_transaction_form') }}" class="btn btn-primary">Добавить операцию</a>
    </div>

    <!-- TODO: Filters can go here -->

    <div class="table-responsive">
        <table class="table table-striped table-hover table-sm">
            <thead>
                <tr>
                    <th>Дата</th>
                    <th>Счет</th>
                    <th>Тип</th>
                    <th>Описание / Детали</th>
                    <th class="text-end">Сумма</th>
                    <th style="width: 50px;"></th>
                </tr>
            </thead>
            <tbody>
                {% for tx in transactions %}
                <tr>
                    <td class="text-nowrap">{{ tx.date.strftime('%d.%m.%Y %H:%M') }}</td>
                    <td class="text-nowrap">
                        {{ tx.account_ref.name }}
                        {% if tx.transaction_type == 'transfer' and tx.to_account_ref %}
                            <i class="fas fa-arrow-right text-muted mx-1"></i> {{ tx.to_account_ref.name }}
                        {% endif %}
                    </td>
                    <td>
                        {% if tx.transaction_type == 'income' %}
                            <span class="badge bg-success">Доход</span>
                        {% elif tx.transaction_type == 'expense' %}
                            <span class="badge bg-danger">Расход</span>
                        {% elif tx.transaction_type == 'transfer' %}
                            <span class="badge bg-info">Перевод</span>
                        {% elif tx.transaction_type == 'exchange' %}
                            <span class="badge bg-warning">Обмен</span>
                        {% else %}
                            <span class="badge bg-secondary">{{ tx.transaction_type }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if tx.description %}<strong>{{ tx.description }}</strong><br>{% endif %}
                        {% if tx.merchant %}<span class="text-info small">{{ tx.merchant }}</span><br>{% endif %}
                        {% if tx.items %}
                            <ul class="list-unstyled small mt-1 mb-0">
                            {% for item in tx.items %}
                                <li title="{{ item.quantity }} x {{ item.price }}">
                                    <span class="text-muted">{{ item.name }}</span>
                                    <small>({{ item.quantity|trim_zeros }} x {{ item.price|trim_zeros }})</small>
                                    {% if item.category %}
                                        <span class="badge rounded-pill bg-light text-dark">{{ item.category.name }}</span>
                                    {% endif %}
                                </li>
                            {% endfor %}
                            </ul>
                        {% elif tx.category_ref %}
                            <span class="badge rounded-pill bg-light text-dark">{{ tx.category_ref.name }}</span>
                        {% endif %}
                    </td>
                    <td class="text-end text-nowrap">
                        {% if tx.transaction_type == 'exchange' %}
                            <strong class="text-danger">-{{ tx.amount|trim_zeros }} {{ tx.account_ref.currency }}</strong><br>
                            <strong class="text-success">+{{ tx.to_amount|trim_zeros }} {{ tx.to_account_ref.currency }}</strong>
                        {% else %}
                            <strong class="{{ 'text-success' if tx.transaction_type == 'income' else 'text-danger' if tx.transaction_type in ['expense', 'transfer'] else '' }}">
                                {{ '-' if tx.transaction_type in ['expense', 'transfer'] else '+' }}{{ tx.amount|trim_zeros }} {{ tx.account_ref.currency }}
                            </strong>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('main.ui_edit_transaction_form', tx_id=tx.id) }}" class="btn btn-sm btn-outline-secondary" title="Редактировать">
                            <i class="fas fa-pencil-alt"></i>
                        </a>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="text-center">Транзакций пока нет.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if pagination and pagination.pages > 1 %}
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}"><a class="page-link" href="{{ url_for('main.ui_transactions', page=pagination.prev_num, **request.args) }}">«</a></li>
            {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                {% if page_num %}<li class="page-item {% if page_num == pagination.page %}active{% endif %}"><a class="page-link" href="{{ url_for('main.ui_transactions', page=page_num, **request.args) }}">{{ page_num }}</a></li>
                {% else %}<li class="page-item disabled"><span class="page-link">…</span></li>{% endif %}
            {% endfor %}
            <li class="page-item {% if not pagination.has_next %}disabled{% endif %}"><a class="page-link" href="{{ url_for('main.ui_transactions', page=pagination.next_num, **request.args) }}">»</a></li>
        </ul>
    </nav>
    {% endif %}
</div>
{% endblock %}